/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package CS5003;

/**
 *
 * @author Daniel O'Sullivan
 */

import java.util.ArrayList;
import java.io.*;

public class Database implements Serializable {
    
    // Serial version ID
    
    private static final long serialVersionUID = 1L;
    
    // Initialise Arraylist
    
    private final ArrayList<Product> products = new ArrayList<>();
    
    public void displayAll()
    {
        for (Product product1 : products)
        {
            product1.display();
            System.out.println("-----------");
            
        }
    }
    
    public void addProduct(String name, int quantity)
    {
        if (quantity < 0) // Can only add a positive number of products
        {
            System.out.println("Error: Quantity cannot be negative.");
            return;        
        }
        Product latest = new Product(name, quantity);
        products.add(latest);
        Activity mostRecent = new Activity("AddToStock", quantity);
        latest.addActivity(mostRecent);
    }
    
    public void deleteProduct(int ID)
    {
       for (int i =0; i< products.size(); i++)
       {
           if (products.get(i).getProductId() == ID)
           {
               products.remove(i);
               System.out.println("Product " + ID + " deleted successfully.");
               return;
           }
       }
       System.out.println("Product not found.");
    }
    
    public void displayMostRecentActivities(int ID)
    {
      for (Product product1 : products)
      {
          if (product1.getProductId() == ID)
          {
              System.out.println("Activities for Product " + ID + ":");
              
              Activity[] acts = product1.getActivities();
              
              // Count non-null activities
              int n = 0;
              for (Activity a : acts) 
              {
                  if (a != null) n++;
              }
              
              // Merge sort (desccending order by activity quantity)
              if (n > 1)
              {
                  mergeSortActivities(acts, 0, n - 1);
              }
              
              // Display non-null sorted activities
              for (int i = 0; i < n; i++)
              {
                      acts[i].display();
                      System.out.println("-----------");
              }
              return;
          }
      }
      System.out.println("Product not found.");
    }
    
    // Save using Serialization
    
    public void saveToFile(String filename)
    {
        try (ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(filename)))
        {
            out.writeObject(this);
            System.out.println("Database saved successfully to " + filename);
        } catch (IOException e)
        {
            System.out.println("Error saving database: " + e.getMessage());
        }
    }
    
    // Load using Serialization
    
    public static Database loadFromFile(String filename)
    {
       try (ObjectInputStream in = new ObjectInputStream(new FileInputStream(filename)))
       {
           Database db = (Database) in.readObject();
           db.recomputeNextIds();
           System.out.println("Database loaded successfully from " + filename);
           return db;
       } catch (IOException | ClassNotFoundException e)
       {
           System.out.println("Error loading database: " + e.getMessage());
           return new Database();
       }
    }
    
    // Recomputing next IDs after load
    
    public void recomputeNextIds()
    {
        int maxProd = 0;
        int maxAct = 0;
        for (Product p: products)
        {
            if (p.getProductId() > maxProd) maxProd = p.getProductId();
            for (Activity a : p.getActivities())
            {
                if (a != null && a.getActivityId() > maxAct) maxAct = a.getActivityId();
            }
        }
        Product.nextProductId = maxProd + 1;
        Activity.nextActivityId = maxAct + 1;
    }     
    
    public java.util.List<Product> getProducts()
    {
        return products;
    }
    
    private void mergeSortActivities(Activity[] arr, int left, int right)
    {
        if (left >= right)
        {
           return;
        }
        
        int mid = left + (right - left) / 2;
        
        mergeSortActivities(arr, left, mid);
        mergeSortActivities(arr, mid + 1, right);
        
        mergeActivities(arr, left, mid, right);
                           
    }
    
    private void mergeActivities(Activity[] arr, int left, int mid, int right)
    {
        int n1 = mid - left + 1;
        int n2 = right - mid;
        
        Activity[] L = new Activity[n1];
        Activity[] R = new Activity[n2];
        
        // Copy data to temporary arrays
        for (int i = 0; i < n1; i++)
        {
            L[i] = arr[left + i];
        }
        for (int j = 0; j < n2; j++)
        {
            R[j] = arr[mid + 1 + j];
        }
        
        int i = 0, j = 0;
        int k = left;
        
        // Merge the two temporary arrays
        while (i < n1 && j < n2)
        {
            if (L[i].getActivityQuantity() >= R[j].getActivityQuantity())
            {
                arr[k] = L[i];
                i++;       
            }
            else 
            {
                arr[k] = R[j];
                j++;
            }
            k++;
        }
        // Copy remaining elements of L[], if any
        while (i < n1)
        {
            arr[k] = L[i];
            i++;
            k++;
        }
        // Copy remaining elements of R[], if any
        while (j < n2)
        {
            arr[k] = R[j];
            j++;
            k++;
        }
    }
}
